<ui:FluentWindow x:Class="ItemEditor.Dialogs.HelpWindow"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                xmlns:vm="clr-namespace:ItemEditor.ViewModels"
                mc:Ignorable="d"
                Title="ItemEditor Help"
                Width="900"
                Height="700"
                MinWidth="600"
                MinHeight="400"
                WindowStartupLocation="CenterOwner"
                d:DataContext="{d:DesignInstance Type=vm:HelpViewModel}">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" 
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,0,0,1"
               Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Search Box -->
                <ui:TextBox Grid.Column="0"
                           PlaceholderText="Search help topics..."
                           Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                           Icon="{ui:SymbolIcon Search16}"
                           ClearButtonEnabled="True"
                           MaxWidth="400"
                           HorizontalAlignment="Left"/>
                
                <!-- Navigation Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <ui:Button Command="{Binding BackCommand}"
                              Icon="{ui:SymbolIcon ArrowLeft16}"
                              ToolTip="Back"
                              Appearance="Subtle"
                              Margin="4,0"/>
                    <ui:Button Command="{Binding ForwardCommand}"
                              Icon="{ui:SymbolIcon ArrowRight16}"
                              ToolTip="Forward"
                              Appearance="Subtle"
                              Margin="4,0"/>
                    <ui:Button Command="{Binding HomeCommand}"
                              Icon="{ui:SymbolIcon Home16}"
                              ToolTip="Home"
                              Appearance="Subtle"
                              Margin="4,0"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="300"/>
            </Grid.ColumnDefinitions>
            
            <!-- Navigation Panel -->
            <ui:Card Grid.Column="0" Margin="8,8,4,8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Navigation Header -->
                    <ui:TextBlock Grid.Row="0" 
                                 Text="Contents" 
                                 FontTypography="BodyStrong"
                                 Margin="0,0,0,8"/>
                    
                    <!-- Navigation Tree -->
                    <TreeView Grid.Row="1"
                             ItemsSource="{Binding HelpCategories}"
                             SelectedItemChanged="OnNavigationSelectionChanged"
                             Background="Transparent"
                             BorderThickness="0">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Symbol="{Binding Icon}" 
                                                  Width="16" Height="16"
                                                  Margin="0,0,4,0"/>
                                    <TextBlock Text="{Binding Title}" 
                                              VerticalAlignment="Center"/>
                                </StackPanel>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </Grid>
            </ui:Card>
            
            <!-- Splitter -->
            <GridSplitter Grid.Column="1" 
                         Width="4" 
                         HorizontalAlignment="Center" 
                         VerticalAlignment="Stretch"
                         Background="Transparent"/>
            
            <!-- Content Panel -->
            <ui:Card Grid.Column="2" Margin="4,8,8,8">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="16">
                        <!-- Search Results -->
                        <ItemsControl ItemsSource="{Binding SearchResults}"
                                     Visibility="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ui:Card Margin="0,0,0,8" 
                                            Padding="12"
                                            Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}">
                                        <StackPanel>
                                            <ui:TextBlock Text="{Binding Content.Title}" 
                                                         FontTypography="BodyStrong"
                                                         Margin="0,0,0,4"/>
                                            <ui:TextBlock Text="{Binding Content.Description}" 
                                                         TextWrapping="Wrap"
                                                         Margin="0,0,0,4"/>
                                            <ui:TextBlock FontTypography="Caption"
                                                         Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                                <Run Text="Category:"/>
                                                <Run Text="{Binding Content.Category}"/>
                                                <Run Text="â€¢ Relevance:"/>
                                                <Run Text="{Binding Relevance, StringFormat=F1}"/>
                                            </ui:TextBlock>
                                        </StackPanel>
                                    </ui:Card>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <!-- Help Content -->
                        <StackPanel Visibility="{Binding IsSearching, Converter={StaticResource InvertedBooleanToVisibilityConverter}}">
                            <!-- Title -->
                            <ui:TextBlock Text="{Binding CurrentContent.Title}" 
                                         FontTypography="TitleLarge"
                                         Margin="0,0,0,16"/>
                            
                            <!-- Description -->
                            <ui:TextBlock Text="{Binding CurrentContent.Description}" 
                                         FontTypography="Body"
                                         TextWrapping="Wrap"
                                         Margin="0,0,0,16"
                                         Visibility="{Binding CurrentContent.Description, Converter={StaticResource StringToVisibilityConverter}}"/>
                            
                            <!-- Detailed Content -->
                            <ui:TextBlock Text="{Binding CurrentContent.DetailedContent}" 
                                         FontTypography="Body"
                                         TextWrapping="Wrap"
                                         Margin="0,0,0,16"
                                         Visibility="{Binding CurrentContent.DetailedContent, Converter={StaticResource StringToVisibilityConverter}}"/>
                            
                            <!-- Steps -->
                            <ItemsControl ItemsSource="{Binding CurrentContent.Steps}"
                                         Visibility="{Binding CurrentContent.Steps.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ui:Card Margin="0,0,0,12" 
                                                Padding="16"
                                                Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- Step Number -->
                                                <Border Grid.Column="0"
                                                       Width="24" Height="24"
                                                       Background="{DynamicResource AccentFillColorDefaultBrush}"
                                                       CornerRadius="12"
                                                       Margin="0,0,12,0">
                                                    <ui:TextBlock Text="{Binding StepNumber}" 
                                                                 HorizontalAlignment="Center"
                                                                 VerticalAlignment="Center"
                                                                 Foreground="White"
                                                                 FontWeight="Bold"/>
                                                </Border>
                                                
                                                <!-- Step Content -->
                                                <StackPanel Grid.Column="1">
                                                    <ui:TextBlock Text="{Binding Title}" 
                                                                 FontTypography="BodyStrong"
                                                                 Margin="0,0,0,4"/>
                                                    <ui:TextBlock Text="{Binding Description}" 
                                                                 TextWrapping="Wrap"/>
                                                </StackPanel>
                                            </Grid>
                                        </ui:Card>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            
                            <!-- Links -->
                            <ItemsControl ItemsSource="{Binding CurrentContent.Links}"
                                         Visibility="{Binding CurrentContent.Links.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ui:Button Content="{Binding Text}"
                                                  Command="{Binding DataContext.OpenLinkCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"
                                                  Appearance="Subtle"
                                                  Icon="{ui:SymbolIcon Link16}"
                                                  Margin="0,0,8,4"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                        
                        <!-- No Content Message -->
                        <StackPanel HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   Visibility="{Binding HasContent, Converter={StaticResource InvertedBooleanToVisibilityConverter}}">
                            <ui:SymbolIcon Symbol="QuestionCircle48" 
                                          FontSize="48"
                                          Foreground="{DynamicResource TextFillColorDisabledBrush}"
                                          Margin="0,0,0,16"/>
                            <ui:TextBlock Text="Select a topic from the navigation panel" 
                                         FontTypography="BodyLarge"
                                         Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                         HorizontalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </ui:Card>
        </Grid>
        
        <!-- Footer -->
        <Border Grid.Row="2" 
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,1,0,0"
               Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Status -->
                <ui:TextBlock Grid.Column="0"
                             Text="{Binding StatusText}"
                             FontTypography="Caption"
                             Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                             VerticalAlignment="Center"/>
                
                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <ui:Button Content="Start Tour"
                              Command="{Binding StartTourCommand}"
                              Icon="{ui:SymbolIcon Play16}"
                              Margin="4,0"/>
                    <ui:Button Content="Close"
                              Command="{Binding CloseCommand}"
                              Appearance="Primary"
                              Margin="4,0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>