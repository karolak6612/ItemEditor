<UserControl x:Class="ItemEditor.Controls.UndoRedoStatusControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:vm="clr-namespace:ItemEditor.ViewModels"
             x:Name="Root">
    
    <UserControl.Resources>
        <!-- Animation for status changes -->
        <Storyboard x:Key="StatusChangeAnimation">
            <DoubleAnimation Storyboard.TargetName="StatusCard"
                           Storyboard.TargetProperty="Opacity"
                           From="0" To="1"
                           Duration="0:0:0.3"/>
            <DoubleAnimation Storyboard.TargetName="StatusCard"
                           Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                           From="0.8" To="1"
                           Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <QuadraticEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="StatusCard"
                           Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                           From="0.8" To="1"
                           Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <QuadraticEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Auto-hide animation -->
        <Storyboard x:Key="AutoHideAnimation">
            <DoubleAnimation Storyboard.TargetName="StatusCard"
                           Storyboard.TargetProperty="Opacity"
                           From="1" To="0"
                           Duration="0:0:0.5"
                           BeginTime="0:0:3"/>
        </Storyboard>
    </UserControl.Resources>
    
    <Grid>
        <!-- Status Card -->
        <ui:Card x:Name="StatusCard"
                 Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                 BorderBrush="{DynamicResource AccentFillColorDefaultBrush}"
                 BorderThickness="1"
                 CornerRadius="4"
                 Padding="12,8"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Top"
                 Margin="0,16,0,0"
                 Opacity="0"
                 Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            
            <ui:Card.RenderTransform>
                <ScaleTransform ScaleX="1" ScaleY="1" CenterX="0.5" CenterY="0.5"/>
            </ui:Card.RenderTransform>
            
            <StackPanel Orientation="Horizontal">
                <!-- Status Icon -->
                <ui:SymbolIcon x:Name="StatusIcon"
                              Symbol="Checkmark16"
                              Foreground="{DynamicResource SystemFillColorSuccessBrush}"
                              Margin="0,0,8,0"
                              VerticalAlignment="Center"/>
                
                <!-- Status Text -->
                <ui:TextBlock x:Name="StatusText"
                             Text="{Binding StatusMessage}"
                             FontTypography="Body"
                             VerticalAlignment="Center"/>
                
                <!-- Undo/Redo Info -->
                <StackPanel Orientation="Horizontal" 
                           Margin="16,0,0,0"
                           Visibility="{Binding ShowUndoRedoInfo, Converter={StaticResource BooleanToVisibilityConverter}}">
                    
                    <!-- Undo Button -->
                    <ui:Button Command="{Binding UndoCommand}"
                              Icon="{ui:SymbolIcon ArrowUndo16}"
                              ToolTip="{Binding UndoTooltip}"
                              Appearance="Subtle"
                              Width="24" Height="24"
                              Margin="4,0"/>
                    
                    <!-- Redo Button -->
                    <ui:Button Command="{Binding RedoCommand}"
                              Icon="{ui:SymbolIcon ArrowRedo16}"
                              ToolTip="{Binding RedoTooltip}"
                              Appearance="Subtle"
                              Width="24" Height="24"
                              Margin="4,0"/>
                    
                    <!-- Stack Info -->
                    <ui:TextBlock FontTypography="Caption"
                                 Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                 VerticalAlignment="Center"
                                 Margin="8,0,0,0">
                        <Run Text="{Binding UndoStackSize, Mode=OneWay}"/>
                        <Run Text="undo"/>
                        <Run Text="•"/>
                        <Run Text="{Binding RedoStackSize, Mode=OneWay}"/>
                        <Run Text="redo"/>
                    </ui:TextBlock>
                </StackPanel>
            </StackPanel>
        </ui:Card>
        
        <!-- Floating Action Buttons -->
        <StackPanel Orientation="Horizontal"
                   HorizontalAlignment="Right"
                   VerticalAlignment="Bottom"
                   Margin="0,0,16,16"
                   Visibility="{Binding ShowFloatingButtons, Converter={StaticResource BooleanToVisibilityConverter}}">
            
            <!-- Undo FAB -->
            <ui:Button Command="{Binding UndoCommand}"
                      Style="{StaticResource FloatingActionButtonStyle}"
                      ToolTip="{Binding UndoTooltip}"
                      Margin="0,0,8,0"
                      Visibility="{Binding CanUndo, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ui:SymbolIcon Symbol="ArrowUndo20" FontSize="20"/>
            </ui:Button>
            
            <!-- Redo FAB -->
            <ui:Button Command="{Binding RedoCommand}"
                      Style="{StaticResource FloatingActionButtonStyle}"
                      ToolTip="{Binding RedoTooltip}"
                      Visibility="{Binding CanRedo, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ui:SymbolIcon Symbol="ArrowRedo20" FontSize="20"/>
            </ui:Button>
        </StackPanel>
        
        <!-- History Panel -->
        <Border x:Name="HistoryPanel"
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="1"
               CornerRadius="4"
               Width="300"
               MaxHeight="400"
               HorizontalAlignment="Right"
               VerticalAlignment="Top"
               Margin="0,60,16,0"
               Visibility="{Binding ShowHistoryPanel, Converter={StaticResource BooleanToVisibilityConverter}}">
            
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Header -->
                <Border Grid.Row="0"
                       Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                       BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                       BorderThickness="0,0,0,1"
                       Padding="12,8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <ui:TextBlock Grid.Column="0"
                                     Text="Command History"
                                     FontTypography="BodyStrong"/>
                        
                        <ui:Button Grid.Column="1"
                                  Command="{Binding CloseHistoryCommand}"
                                  Content="×"
                                  Width="20" Height="20"
                                  Appearance="Subtle"/>
                    </Grid>
                </Border>
                
                <!-- History List -->
                <ScrollViewer Grid.Row="1" 
                             VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding CommandHistory}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="12,6"
                                       Background="{Binding IsCurrentPosition, Converter={StaticResource BooleanToBackgroundConverter}}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Command Icon -->
                                        <ui:SymbolIcon Grid.Column="0"
                                                      Symbol="{Binding CommandType, Converter={StaticResource CommandTypeToIconConverter}}"
                                                      Width="16" Height="16"
                                                      Margin="0,0,8,0"
                                                      Opacity="{Binding IsExecuted, Converter={StaticResource BooleanToOpacityConverter}}"/>
                                        
                                        <!-- Command Description -->
                                        <StackPanel Grid.Column="1">
                                            <ui:TextBlock Text="{Binding Description}"
                                                         FontTypography="Body"
                                                         Opacity="{Binding IsExecuted, Converter={StaticResource BooleanToOpacityConverter}}"/>
                                            <ui:TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                                         FontTypography="Caption"
                                                         Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                        </StackPanel>
                                        
                                        <!-- Action Button -->
                                        <ui:Button Grid.Column="2"
                                                  Command="{Binding JumpToCommand}"
                                                  CommandParameter="{Binding}"
                                                  Content="Go"
                                                  Appearance="Subtle"
                                                  FontSize="10"
                                                  Padding="4,2"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
                
                <!-- Footer -->
                <Border Grid.Row="2"
                       Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                       BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                       BorderThickness="0,1,0,0"
                       Padding="12,8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <ui:TextBlock Grid.Column="0"
                                     FontTypography="Caption"
                                     Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                            <Run Text="{Binding TotalCommands, Mode=OneWay}"/>
                            <Run Text="commands"/>
                        </ui:TextBlock>
                        
                        <ui:Button Grid.Column="1"
                                  Command="{Binding ClearHistoryCommand}"
                                  Content="Clear All"
                                  Appearance="Subtle"
                                  FontSize="10"/>
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>