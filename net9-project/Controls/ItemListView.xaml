<UserControl x:Class="ItemEditor.Controls.ItemListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:controls="clr-namespace:ItemEditor.Controls"
             xmlns:viewmodels="clr-namespace:ItemEditor.ViewModels"
             xmlns:converters="clr-namespace:ItemEditor.Converters"
             x:Name="Root">
    
    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- Item Card Style -->
        <Style x:Key="ItemCardStyle" TargetType="ui:Card">
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorSecondaryBrush}"/>
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentFillColorDefaultBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Item Template -->
        <DataTemplate x:Key="ItemTemplate" DataType="{x:Type viewmodels:ItemViewModel}">
            <ui:Card Style="{StaticResource ItemCardStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="48"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Thumbnail -->
                    <Border Grid.Column="0" 
                            Width="32" Height="32"
                            Background="{DynamicResource SystemFillColorSolidNeutralBackgroundBrush}"
                            BorderBrush="{DynamicResource SystemFillColorSolidNeutralBrush}"
                            BorderThickness="1"
                            CornerRadius="2">
                        <Grid>
                            <Image Source="{Binding Thumbnail}" 
                                   Stretch="Uniform"
                                   RenderOptions.BitmapScalingMode="NearestNeighbor"/>
                            
                            <!-- Loading indicator -->
                            <ui:ProgressRing IsIndeterminate="True"
                                            Width="16" Height="16"
                                            Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        </Grid>
                    </Border>
                    
                    <!-- Item Information -->
                    <StackPanel Grid.Column="1" 
                               Margin="8,0,0,0"
                               VerticalAlignment="Center">
                        <ui:TextBlock Text="{Binding DisplayText}" 
                                     FontTypography="BodyStrong"
                                     TextTrimming="CharacterEllipsis"/>
                        <ui:TextBlock Text="{Binding TypeDisplayName}" 
                                     FontTypography="Caption"
                                     Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                        <ui:TextBlock Text="{Binding Description}" 
                                     FontTypography="Caption"
                                     Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                     TextTrimming="CharacterEllipsis"
                                     MaxWidth="200"/>
                    </StackPanel>
                    
                    <!-- Status and Actions -->
                    <StackPanel Grid.Column="2" 
                               Orientation="Horizontal"
                               VerticalAlignment="Center">
                        
                        <!-- Status Indicator -->
                        <Border Width="8" Height="8"
                               CornerRadius="4"
                               Margin="0,0,8,0"
                               ToolTip="{Binding StatusText}">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="{DynamicResource SystemFillColorSuccessBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsDirty}" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource SystemFillColorCautionBrush}"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource SystemFillColorCriticalBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>
                        
                        <!-- Quick Actions -->
                        <StackPanel Orientation="Horizontal" 
                                   Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <ui:Button Icon="{ui:SymbolIcon Refresh16}"
                                      Command="{Binding RefreshThumbnailCommand}"
                                      ToolTip="Refresh Thumbnail"
                                      Appearance="Subtle"
                                      Margin="2,0"/>
                            <ui:Button Icon="{ui:SymbolIcon Save16}"
                                      Command="{Binding SaveItemCommand}"
                                      ToolTip="Save Item"
                                      Appearance="Subtle"
                                      Margin="2,0"/>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </ui:Card>
        </DataTemplate>
        
        <!-- List Item Container Style -->
        <Style x:Key="ItemContainerStyle" TargetType="ListViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Border Background="{TemplateBinding Background}"
                               BorderBrush="{TemplateBinding BorderBrush}"
                               BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                            VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                            Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ListViewItemBackgroundSelected}"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsSelected" Value="True"/>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                </MultiTrigger.Conditions>
                                <Setter Property="Background" Value="{DynamicResource ListViewItemBackgroundSelectedPointerOver}"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header with Search and Controls -->
        <Border Grid.Row="0" 
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,0,0,1"
               Padding="12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Search Box -->
                <ui:TextBox Grid.Column="0"
                           PlaceholderText="Search items..."
                           Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                           Icon="{ui:SymbolIcon Search16}"
                           ClearButtonEnabled="True"
                           Margin="0,0,8,0"/>
                
                <!-- View Options -->
                <StackPanel Grid.Column="1" 
                           Orientation="Horizontal">
                    <ui:ToggleButton Content="Show Thumbnails"
                                    IsChecked="{Binding ShowThumbnails}"
                                    Icon="{ui:SymbolIcon Image16}"
                                    Margin="4,0"/>
                    <ui:Button Content="Refresh All"
                              Command="{Binding RefreshAllCommand}"
                              Icon="{ui:SymbolIcon ArrowClockwise16}"
                              Appearance="Subtle"
                              Margin="4,0"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main List View -->
        <ui:ListView Grid.Row="1"
                    x:Name="ItemsListView"
                    ItemsSource="{Binding FilteredItems}"
                    SelectedItem="{Binding SelectedItem}"
                    ItemTemplate="{StaticResource ItemTemplate}"
                    ItemContainerStyle="{StaticResource ItemContainerStyle}"
                    SelectionMode="{Binding SelectionMode}"
                    VirtualizingPanel.IsVirtualizing="True"
                    VirtualizingPanel.VirtualizationMode="Recycling"
                    VirtualizingPanel.IsContainerVirtualizable="True"
                    ScrollViewer.CanContentScroll="True"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    Background="Transparent"
                    BorderThickness="0">
            
            <!-- Context Menu -->
            <ui:ListView.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Refresh Thumbnail" 
                             Command="{Binding SelectedItem.RefreshThumbnailCommand}"
                             Icon="{ui:SymbolIcon Refresh16}"/>
                    <MenuItem Header="Save Item" 
                             Command="{Binding SelectedItem.SaveItemCommand}"
                             Icon="{ui:SymbolIcon Save16}"/>
                    <Separator/>
                    <MenuItem Header="Clone Item" 
                             Command="{Binding SelectedItem.CloneItemCommand}"
                             Icon="{ui:SymbolIcon Copy16}"/>
                    <MenuItem Header="Delete Item" 
                             Command="{Binding DeleteItemCommand}"
                             CommandParameter="{Binding SelectedItem}"
                             Icon="{ui:SymbolIcon Delete16}"/>
                    <Separator/>
                    <MenuItem Header="Properties" 
                             Command="{Binding ShowPropertiesCommand}"
                             CommandParameter="{Binding SelectedItem}"
                             Icon="{ui:SymbolIcon Settings16}"/>
                </ContextMenu>
            </ui:ListView.ContextMenu>
        </ui:ListView>
        
        <!-- Loading Overlay -->
        <Border Grid.Row="1"
               Background="{DynamicResource SystemFillColorSolidBackgroundBaseBrush}"
               Opacity="0.8"
               Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" 
                       VerticalAlignment="Center">
                <ui:ProgressRing IsIndeterminate="True" 
                               Width="32" Height="32"/>
                <ui:TextBlock Text="{Binding LoadingMessage}" 
                             FontTypography="Body"
                             Margin="0,8,0,0"
                             HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
        
        <!-- Status Bar -->
        <Border Grid.Row="2" 
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,1,0,0"
               Padding="12,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <ui:TextBlock Grid.Column="0"
                             FontTypography="Caption"
                             Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                    <Run Text="{Binding FilteredItems.Count, Mode=OneWay}"/>
                    <Run Text="of"/>
                    <Run Text="{Binding TotalItems, Mode=OneWay}"/>
                    <Run Text="items"/>
                    <Run Text="â€¢"/>
                    <Run Text="{Binding SelectedItems.Count, Mode=OneWay}"/>
                    <Run Text="selected"/>
                </ui:TextBlock>
                
                <StackPanel Grid.Column="1" 
                           Orientation="Horizontal">
                    <ui:TextBlock Text="{Binding StatusMessage}"
                                 FontTypography="Caption"
                                 Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                 Margin="0,0,8,0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>