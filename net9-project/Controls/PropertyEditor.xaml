<UserControl x:Class="ItemEditor.Controls.PropertyEditor"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:controls="clr-namespace:ItemEditor.Controls"
             xmlns:viewmodels="clr-namespace:ItemEditor.ViewModels"
             xmlns:models="clr-namespace:ItemEditor.Models"
             xmlns:converters="clr-namespace:ItemEditor.Converters"
             x:Name="Root">
    
    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter"/>
        
        <!-- Error Template -->
        <ControlTemplate x:Key="ErrorTemplate">
            <DockPanel>
                <Border DockPanel.Dock="Right" 
                       Background="{DynamicResource SystemFillColorCriticalBrush}"
                       Width="12" Height="12"
                       CornerRadius="6"
                       Margin="4,0,0,0"
                       ToolTip="{Binding ElementName=ErrorAdorner, Path=AdornedElement.(Validation.Errors)[0].ErrorContent}">
                    <ui:SymbolIcon Symbol="ErrorCircle12" 
                                  Foreground="White"
                                  FontSize="8"/>
                </Border>
                <AdornedElementPlaceholder x:Name="ErrorAdorner"/>
            </DockPanel>
        </ControlTemplate>
        
        <!-- Property Group Style -->
        <Style x:Key="PropertyGroupStyle" TargetType="ui:Expander">
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="IsExpanded" Value="True"/>
        </Style>
        
        <!-- Property Label Style -->
        <Style x:Key="PropertyLabelStyle" TargetType="ui:TextBlock">
            <Setter Property="FontTypography" Value="BodyStrong"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        
        <!-- Property Control Style -->
        <Style x:Key="PropertyControlStyle" TargetType="FrameworkElement">
            <Setter Property="Margin" Value="0,0,0,12"/>
            <Setter Property="Validation.ErrorTemplate" Value="{StaticResource ErrorTemplate}"/>
        </Style>
        
        <!-- Item Type Collection -->
        <x:Array x:Key="ItemTypes" Type="models:ItemType">
            <models:ItemType>None</models:ItemType>
            <models:ItemType>Ground</models:ItemType>
            <models:ItemType>Container</models:ItemType>
            <models:ItemType>Weapon</models:ItemType>
            <models:ItemType>Ammunition</models:ItemType>
            <models:ItemType>Armor</models:ItemType>
            <models:ItemType>Charges</models:ItemType>
            <models:ItemType>Teleport</models:ItemType>
            <models:ItemType>MagicField</models:ItemType>
            <models:ItemType>Writeable</models:ItemType>
            <models:ItemType>Key</models:ItemType>
            <models:ItemType>Splash</models:ItemType>
            <models:ItemType>Fluid</models:ItemType>
            <models:ItemType>Door</models:ItemType>
        </x:Array>
        
        <!-- Stack Order Collection -->
        <x:Array x:Key="StackOrders" Type="models:TileStackOrder">
            <models:TileStackOrder>None</models:TileStackOrder>
            <models:TileStackOrder>Ground</models:TileStackOrder>
            <models:TileStackOrder>Border</models:TileStackOrder>
            <models:TileStackOrder>Bottom</models:TileStackOrder>
            <models:TileStackOrder>Top</models:TileStackOrder>
        </x:Array>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" 
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,0,0,1"
               Padding="12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <ui:SymbolIcon Symbol="Settings16" 
                                  Margin="0,0,8,0"
                                  VerticalAlignment="Center"/>
                    <ui:TextBlock Text="Item Properties" 
                                 FontTypography="BodyStrong"
                                 VerticalAlignment="Center"/>
                    <ui:TextBlock Text="{Binding SelectedItem.DisplayText, StringFormat=' - {0}'}" 
                                 FontTypography="Body"
                                 Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                 VerticalAlignment="Center"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <ui:Button Content="Reset"
                              Command="{Binding SelectedItem.ResetChangesCommand}"
                              Icon="{ui:SymbolIcon ArrowUndo16}"
                              Appearance="Subtle"
                              Margin="4,0"/>
                    <ui:Button Content="Validate"
                              Command="{Binding SelectedItem.ValidateCommand}"
                              Icon="{ui:SymbolIcon Checkmark16}"
                              Appearance="Subtle"
                              Margin="4,0"/>
                    <ui:Button Content="Save"
                              Command="{Binding SelectedItem.SaveItemCommand}"
                              Icon="{ui:SymbolIcon Save16}"
                              Appearance="Primary"
                              Margin="4,0"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Properties Content -->
        <ScrollViewer Grid.Row="1" 
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollBarVisibility="Disabled"
                     Padding="12">
            <StackPanel Visibility="{Binding SelectedItem, Converter={StaticResource BooleanToVisibilityConverter}}">
                
                <!-- Basic Properties Group -->
                <ui:Expander Header="Basic Properties" 
                            Style="{StaticResource PropertyGroupStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Item Name -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" 
                                   Style="{StaticResource PropertyControlStyle}">
                            <ui:TextBlock Text="Item Name" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:TextBox Text="{Binding SelectedItem.Name, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                       PlaceholderText="Enter item name..."
                                       MaxLength="100"/>
                        </StackPanel>
                        
                        <!-- Item ID -->
                        <StackPanel Grid.Row="1" Grid.Column="0" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="0,0,6,12">
                            <ui:TextBlock Text="Item ID" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:NumberBox Value="{Binding SelectedItem.Id, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                         Minimum="1"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Inline"/>
                        </StackPanel>
                        
                        <!-- Client ID -->
                        <StackPanel Grid.Row="1" Grid.Column="1" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="6,0,0,12">
                            <ui:TextBlock Text="Client ID" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:NumberBox Value="{Binding SelectedItem.ClientId, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                         Minimum="0"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Inline"/>
                        </StackPanel>
                        
                        <!-- Item Type -->
                        <StackPanel Grid.Row="2" Grid.Column="0" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="0,0,6,12">
                            <ui:TextBlock Text="Item Type" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:ComboBox ItemsSource="{StaticResource ItemTypes}"
                                        SelectedItem="{Binding SelectedItem.Type, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                        
                        <!-- Stack Order -->
                        <StackPanel Grid.Row="2" Grid.Column="1" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="6,0,0,12">
                            <ui:TextBlock Text="Stack Order" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:ComboBox ItemsSource="{StaticResource StackOrders}"
                                        SelectedItem="{Binding SelectedItem.Model.StackOrder, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                        
                        <!-- Description -->
                        <StackPanel Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" 
                                   Style="{StaticResource PropertyControlStyle}">
                            <ui:TextBlock Text="Description" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:TextBox Text="{Binding SelectedItem.Description, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                       PlaceholderText="Enter item description..."
                                       MaxLength="500"
                                       AcceptsReturn="True"
                                       TextWrapping="Wrap"
                                       MinHeight="60"/>
                        </StackPanel>
                    </Grid>
                </ui:Expander>
                
                <!-- Behavior Properties Group -->
                <ui:Expander Header="Behavior Properties" 
                            Style="{StaticResource PropertyGroupStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Stackable -->
                        <ui:ToggleSwitch Grid.Row="0" Grid.Column="0"
                                        Content="Stackable"
                                        IsChecked="{Binding SelectedItem.IsStackable, UpdateSourceTrigger=PropertyChanged}"
                                        Margin="0,0,6,12"/>
                        
                        <!-- Moveable -->
                        <ui:ToggleSwitch Grid.Row="0" Grid.Column="1"
                                        Content="Moveable"
                                        IsChecked="{Binding SelectedItem.IsMoveable, UpdateSourceTrigger=PropertyChanged}"
                                        Margin="6,0,0,12"/>
                        
                        <!-- Pickupable -->
                        <ui:ToggleSwitch Grid.Row="1" Grid.Column="0"
                                        Content="Pickupable"
                                        IsChecked="{Binding SelectedItem.IsPickupable, UpdateSourceTrigger=PropertyChanged}"
                                        Margin="0,0,6,12"/>
                        
                        <!-- Rotatable -->
                        <ui:ToggleSwitch Grid.Row="1" Grid.Column="1"
                                        Content="Rotatable"
                                        IsChecked="{Binding SelectedItem.Model.IsRotatable, UpdateSourceTrigger=PropertyChanged}"
                                        Margin="6,0,0,12"/>
                        
                        <!-- Speed -->
                        <StackPanel Grid.Row="2" Grid.Column="0" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="0,0,6,12">
                            <ui:TextBlock Text="Speed" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:NumberBox Value="{Binding SelectedItem.Speed, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                         Minimum="0"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Inline"/>
                        </StackPanel>
                        
                        <!-- Weight -->
                        <StackPanel Grid.Row="2" Grid.Column="1" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="6,0,0,12">
                            <ui:TextBlock Text="Weight" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:NumberBox Value="{Binding SelectedItem.Weight, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                         Minimum="0"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Inline"/>
                        </StackPanel>
                    </Grid>
                </ui:Expander>
                
                <!-- Light Properties Group -->
                <ui:Expander Header="Light Properties" 
                            Style="{StaticResource PropertyGroupStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Has Light -->
                        <ui:ToggleSwitch Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                                        Content="Has Light"
                                        IsChecked="{Binding SelectedItem.HasLight, UpdateSourceTrigger=PropertyChanged}"
                                        Margin="0,0,0,12"/>
                        
                        <!-- Light Level -->
                        <StackPanel Grid.Row="1" Grid.Column="0" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="0,0,6,12"
                                   IsEnabled="{Binding SelectedItem.HasLight}">
                            <ui:TextBlock Text="Light Level" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:NumberBox Value="{Binding SelectedItem.LightLevel, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}"
                                         Minimum="0"
                                         Maximum="255"
                                         SpinButtonPlacementMode="Inline"/>
                        </StackPanel>
                        
                        <!-- Light Color -->
                        <StackPanel Grid.Row="1" Grid.Column="1" 
                                   Style="{StaticResource PropertyControlStyle}"
                                   Margin="6,0,0,12"
                                   IsEnabled="{Binding SelectedItem.HasLight}">
                            <ui:TextBlock Text="Light Color" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:NumberBox Value="{Binding SelectedItem.LightColor, UpdateSourceTrigger=PropertyChanged}"
                                         Minimum="0"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Inline"/>
                        </StackPanel>
                    </Grid>
                </ui:Expander>
                
                <!-- Sprite Properties Group -->
                <ui:Expander Header="Sprite Properties" 
                            Style="{StaticResource PropertyGroupStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Sprite IDs -->
                        <StackPanel Grid.Row="0" Style="{StaticResource PropertyControlStyle}">
                            <ui:TextBlock Text="Sprite IDs" Style="{StaticResource PropertyLabelStyle}"/>
                            <ui:TextBox Text="{Binding SpriteIdsText, UpdateSourceTrigger=PropertyChanged}"
                                       PlaceholderText="Enter sprite IDs separated by commas..."
                                       ToolTip="Enter sprite IDs separated by commas (e.g., 100, 101, 102)"/>
                        </StackPanel>
                        
                        <!-- Sprite Actions -->
                        <StackPanel Grid.Row="1" Orientation="Horizontal">
                            <ui:Button Content="Refresh Thumbnail"
                                      Command="{Binding SelectedItem.RefreshThumbnailCommand}"
                                      Icon="{ui:SymbolIcon Refresh16}"
                                      Appearance="Subtle"
                                      Margin="0,0,8,0"/>
                            <ui:Button Content="View Sprites"
                                      Command="{Binding ViewSpritesCommand}"
                                      CommandParameter="{Binding SelectedItem}"
                                      Icon="{ui:SymbolIcon Image16}"
                                      Appearance="Subtle"
                                      Margin="0,0,8,0"/>
                        </StackPanel>
                    </Grid>
                </ui:Expander>
                
                <!-- Custom Properties Group -->
                <ui:Expander Header="Custom Properties" 
                            Style="{StaticResource PropertyGroupStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Add Custom Property -->
                        <Grid Grid.Row="0" Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <ui:TextBox Grid.Column="0"
                                       Text="{Binding NewPropertyKey, UpdateSourceTrigger=PropertyChanged}"
                                       PlaceholderText="Property name..."
                                       Margin="0,0,4,0"/>
                            <ui:TextBox Grid.Column="1"
                                       Text="{Binding NewPropertyValue, UpdateSourceTrigger=PropertyChanged}"
                                       PlaceholderText="Property value..."
                                       Margin="4,0,4,0"/>
                            <ui:Button Grid.Column="2"
                                      Content="Add"
                                      Command="{Binding AddCustomPropertyCommand}"
                                      Icon="{ui:SymbolIcon Add16}"
                                      Appearance="Primary"/>
                        </Grid>
                        
                        <!-- Custom Properties List -->
                        <ItemsControl Grid.Row="1" 
                                     ItemsSource="{Binding CustomProperties}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource SubtleFillColorSecondaryBrush}"
                                           BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                           BorderThickness="1"
                                           CornerRadius="4"
                                           Padding="8"
                                           Margin="0,0,0,4">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <ui:TextBlock Grid.Column="0"
                                                         Text="{Binding Key}"
                                                         FontTypography="BodyStrong"
                                                         VerticalAlignment="Center"/>
                                            <ui:TextBlock Grid.Column="1"
                                                         Text="{Binding Value}"
                                                         VerticalAlignment="Center"
                                                         Margin="8,0"/>
                                            <ui:Button Grid.Column="2"
                                                      Command="{Binding DataContext.RemoveCustomPropertyCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                      CommandParameter="{Binding Key}"
                                                      Icon="{ui:SymbolIcon Delete16}"
                                                      Appearance="Subtle"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </ui:Expander>
            </StackPanel>
        </ScrollViewer>
        
        <!-- No Selection Message -->
        <Border Grid.Row="1"
               Visibility="{Binding SelectedItem, Converter={StaticResource InvertedBooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" 
                       VerticalAlignment="Center">
                <ui:SymbolIcon Symbol="Settings48" 
                              FontSize="48"
                              Foreground="{DynamicResource TextFillColorDisabledBrush}"
                              Margin="0,0,0,16"/>
                <ui:TextBlock Text="No item selected" 
                             FontTypography="BodyLarge"
                             Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                             HorizontalAlignment="Center"/>
                <ui:TextBlock Text="Select an item from the list to view and edit its properties" 
                             FontTypography="Caption"
                             Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                             HorizontalAlignment="Center"
                             Margin="0,4,0,0"/>
            </StackPanel>
        </Border>
        
        <!-- Status Bar -->
        <Border Grid.Row="2" 
               Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,1,0,0"
               Padding="12,4"
               Visibility="{Binding SelectedItem, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Status Information -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <ui:TextBlock Text="{Binding SelectedItem.StatusText}"
                                 FontTypography="Caption"
                                 VerticalAlignment="Center"/>
                    <ui:TextBlock Text=" • "
                                 FontTypography="Caption"
                                 Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                 VerticalAlignment="Center"
                                 Visibility="{Binding SelectedItem.LastModified, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <ui:TextBlock Text="{Binding SelectedItem.LastModified, StringFormat='Last modified: {0:g}'}"
                                 FontTypography="Caption"
                                 Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                 VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Validation Errors -->
                <ui:TextBlock Grid.Column="1"
                             Text="{Binding SelectedItem.ValidationErrors}"
                             FontTypography="Caption"
                             Foreground="{DynamicResource SystemFillColorCriticalBrush}"
                             VerticalAlignment="Center"
                             Visibility="{Binding SelectedItem.HasErrors, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>