# ItemEditor Project Development Guide

## Project Overview

ItemEditor is a specialized tool for editing OTB (Open Tibia Binary) data files used in game development. This workspace contains both the legacy Windows Forms/.NET Framework 4.6.1 C# application and its modern Qt6-based C++ migration.

### Key Information
- **Purpose**: Edit OTB data files for game development (versions 8.00-10.77)
- **Legacy Framework**: Windows Forms/.NET Framework 4.6.1 (C#)
- **Target Framework**: Qt6 with C++17/20
- **Architecture**: Plugin-based system with dark UI theme
- **Platform**: Windows x64 (primary), cross-platform capable

## Project Structure

### Legacy Application (`Legacy_App/`)
- **Language**: C# (.NET Framework 4.6.1)
- **UI Framework**: Windows Forms with DarkUI theme
- **Build System**: Visual Studio solution (.sln)
- **Plugin System**: .NET reflection-based plugin loading
- **Key Features**: OTB file editing, sprite visualization, item attribute management

### Modern Migration (`ItemEditor.Qt6/`)
- **Language**: C++17/20
- **UI Framework**: Qt6 (6.5+ LTS recommended)
- **Build System**: CMake with Qt6 integration
- **Plugin System**: Native Qt6 plugin framework
- **Target**: 100% functional parity with legacy system

## Important Files and Directories

### Core Configuration Files
- `ItemEditor.Qt6/CMakeLists.txt` - Main CMake configuration
- `ItemEditor.Qt6/build.bat` - Windows build script
- `docs/requirements.md` - Detailed functional requirements
- `docs/design.md` - Architecture and migration strategy
- `docs/tasks.md` - Implementation roadmap

### Key Source Directories
- `ItemEditor.Qt6/src/ItemEditor.Core/` - Business logic and data models
- `ItemEditor.Qt6/src/ItemEditor.UI/` - Qt6 UI components and main application
- `ItemEditor.Qt6/src/ItemEditor.Plugins/` - Plugin interfaces and base classes
- `ItemEditor.Qt6/src/ItemEditor.Tests/` - Test suites
- `ItemEditor.Qt6/plugins/` - Plugin implementations (PluginOne, PluginTwo, PluginThree)

### Legacy Reference
- `Legacy_App/Source/` - Original C# implementation for reference
- `Legacy_App/Source/PluginInterface/` - Original plugin interface definitions

## Development Best Practices

### Code Organization
- **Modular Architecture**: Separate Core, UI, Plugins, and Tests into distinct libraries
- **Interface Segregation**: Use abstract interfaces (`IPlugin.h`) for plugin contracts
- **Dependency Injection**: Core business logic independent of UI framework
- **RAII Pattern**: Proper resource management with Qt's parent-child object model

### Qt6 Conventions
- **Header Guards**: Use `#pragma once` for header files
- **Qt Types**: Prefer Qt types (`QString`, `QByteArray`, `quint16`) for consistency
- **Signal/Slot System**: Use Qt's meta-object system for event handling
- **Resource Management**: Use Qt's resource system (`.qrc` files) for assets
- **UI Files**: Store UI layouts in `.ui` files for Qt Designer integration

### Plugin Development
- **Interface Compliance**: All plugins must implement `IPlugin` interface
- **JSON Metadata**: Each plugin requires a `.json` metadata file
- **Version Support**: Plugins handle specific client version ranges
- **Error Handling**: Emit `errorOccurred` signals for proper error propagation
- **Progress Reporting**: Use `loadingProgress` signals for long operations

### File Naming Conventions
- **Headers**: PascalCase with `.h` extension (`ServerItem.h`)
- **Sources**: PascalCase with `.cpp` extension (`ServerItem.cpp`)
- **UI Files**: PascalCase with `.ui` extension (`MainWindow.ui`)
- **Resources**: lowercase with descriptive names (`resources.qrc`)
- **Tests**: Descriptive names with `Test` prefix (`TestPluginLoading.cpp`)

### CMake Structure
- **Modular Libraries**: Each major component is a separate CMake target
- **Qt6 Integration**: Use `qt6_standard_project_setup()` and Qt6 components
- **Test Executables**: Separate test executables for different functionality areas
- **Windows Configuration**: Specific settings for Windows x64 builds

## Build System

### Platform Support
- **Primary**: Windows x64 with MSVC 2019+
- **Secondary**: Linux x64 with GCC 7+ or Clang 5+
- **Cross-Platform**: Qt6 provides consistent API across platforms

### Prerequisites

**Windows:**
- Qt6 (6.5+ LTS recommended)
- CMake 3.16+
- C++17 compatible compiler (MSVC 2019+ for Windows x64)
- Windows SDK

**Linux/Ubuntu:**
- Qt6 (6.5+ LTS recommended)
- CMake 3.16+
- GCC 7+ or Clang 5+ (C++17 support)
- Build essentials: `sudo apt install qt6-base-dev qt6-tools-dev cmake build-essential`

### Build Commands

**Windows:**
```bash
# From ItemEditor.Qt6/ directory
mkdir build
cd build
cmake .. -DCMAKE_PREFIX_PATH=path/to/qt6
cmake --build . --config Release
```

**Linux/Ubuntu:**
```bash
# From ItemEditor.Qt6/ directory
# Install dependencies first:
sudo apt install qt6-base-dev qt6-tools-dev cmake build-essential

# Build using the provided script:
./build.sh

# Or manually:
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
```

### CMake Targets
- `ItemEditor.Core` - Static library with business logic
- `ItemEditor.UI` - Static library with UI components
- `ItemEditor.Plugins` - Static library with plugin interfaces
- `ItemEditor` - Main executable
- `Test*` executables - Various test programs

## UI/UX Guidelines

### Dark Theme Implementation
- **Color Palette**: Based on legacy DarkUI theme colors
- **Primary Background**: `#3c3f41` (60, 63, 65)
- **Secondary Background**: `#45494a` (69, 73, 74)
- **Text Color**: `#dcdcdc` (220, 220, 220)
- **Highlight Color**: `#6897bb` (104, 151, 187)
- **Styling**: Use Qt StyleSheets in `themes/dark.qss`

### Layout Principles
- **Pixel-Perfect Replication**: Match legacy system layouts exactly
- **Responsive Design**: Maintain minimum window sizes and proper resizing
- **Accessibility**: Preserve keyboard navigation and screen reader compatibility
- **Consistency**: Use consistent spacing, fonts, and visual hierarchy

## Data Handling

### File Formats
- **OTB Files**: Binary format for server item data
- **DAT Files**: Client data files with item definitions
- **SPR Files**: Sprite data files with image information
- **XML Files**: Configuration and item definition files

### Data Integrity
- **Byte-Identical Output**: File operations must produce identical results to legacy system
- **Validation Rules**: Implement exact same validation logic as legacy system
- **Error Handling**: Preserve original error messages and recovery behavior
- **Backup Management**: Automatic backup creation before file modifications

## Plugin System Architecture

### Plugin Interface (`IPlugin`)
- **Initialization**: `initialize()` method for plugin setup
- **Client Loading**: `loadClient()` for DAT/SPR file processing
- **Data Access**: Methods for retrieving client data and sprite information
- **Version Support**: `supportedVersions()` for client version compatibility
- **Cleanup**: `cleanup()` for proper resource disposal

### Plugin Implementations
- **PluginOne**: Supports client versions 8.00-8.57
- **PluginTwo**: Supports client versions 8.60-9.86  
- **PluginThree**: Supports client versions 10.00-10.77

### Plugin Loading
- **Discovery**: Automatic plugin discovery in plugins directory
- **Metadata**: JSON files define plugin capabilities and supported versions
- **Validation**: Signature checking and version compatibility verification
- **Error Recovery**: Graceful handling of plugin loading failures

## Testing Strategy

### Test Categories
- **Unit Tests**: Core business logic validation
- **Integration Tests**: Plugin system and file I/O testing
- **UI Tests**: Widget behavior and layout verification
- **Regression Tests**: Compatibility with legacy system behavior

### Test Executables
- `TestPluginLoading` - Plugin discovery and initialization
- `TestDatSprParsing` - File format parsing validation
- `TestSpriteProcessing` - Sprite hash and signature calculation
- `TestItemEditingWorkflow` - End-to-end item editing scenarios
- `TestFileOperations` - OTB file read/write operations

## Migration Guidelines

### Functional Parity Requirements
- **100% Feature Compatibility**: Every legacy feature must be preserved
- **Identical Behavior**: Business logic must produce same results
- **UI Fidelity**: Visual appearance must match pixel-perfect
- **Performance Equivalency**: Meet or exceed legacy performance benchmarks
- **Data Compatibility**: Support existing file formats and configurations

### Development Workflow
1. **Analyze Legacy Code**: Study original C# implementation thoroughly
2. **Define Interfaces**: Create Qt6 equivalents of legacy interfaces
3. **Implement Core Logic**: Port business logic to C++ with exact behavior
4. **Build UI Components**: Recreate forms and controls using Qt6
5. **Test Extensively**: Validate against legacy system behavior
6. **Document Changes**: Maintain traceability to original specifications

## Common Patterns

### Error Handling
```cpp
// Use Qt signals for error reporting
emit errorOccurred(QString("Failed to load client data: %1").arg(error));

// Validate inputs before processing
if (!isValidPath(datPath)) {
    return false;
}
```

### Resource Management
```cpp
// Use Qt's parent-child system
auto widget = new QWidget(parent);

// RAII for file operations
QFile file(path);
if (!file.open(QIODevice::ReadOnly)) {
    return false;
}
// File automatically closed when QFile goes out of scope
```

### Plugin Implementation
```cpp
class PluginOne : public QObject, public IPlugin
{
    Q_OBJECT
    Q_PLUGIN_METADATA(IID "com.itemeditor.IPlugin/1.0" FILE "pluginone.json")
    Q_INTERFACES(IPlugin)
    
public:
    bool initialize() override;
    QString name() const override { return "Plugin One"; }
    // ... implement other interface methods
};
```

## Troubleshooting

### Common Build Issues

**Windows:**
- **Qt6 Path**: Ensure `CMAKE_PREFIX_PATH` points to Qt6 installation
- **Compiler Version**: Use MSVC 2019+ for Windows builds
- **CMake Version**: Minimum CMake 3.16 required for Qt6 support

**Linux/Ubuntu:**
- **Qt6 Packages**: Install `qt6-base-dev qt6-tools-dev` packages
- **Build Tools**: Ensure `build-essential cmake` packages are installed
- **Compiler**: GCC 7+ or Clang 5+ required for C++17 support
- **Plugin Loading**: Verify `LD_LIBRARY_PATH` includes plugin directories
- **Permissions**: Make build script executable: `chmod +x build.sh`

### Runtime Issues

**Cross-Platform:**
- **Plugin Loading**: Check plugin metadata JSON files for syntax errors
- **File Permissions**: Ensure read/write access to OTB files and plugin directories
- **Theme Loading**: Verify `dark.qss` is properly embedded in resources

**Linux-Specific:**
- **Library Path**: Set `LD_LIBRARY_PATH` to include Qt6 and plugin directories
- **Desktop Integration**: Install desktop entry: `sudo make install`
- **File Associations**: Configure MIME types for .otb files
- **Display Issues**: Ensure proper X11/Wayland display server configuration

### Performance Considerations
- **Memory Management**: Use Qt's object hierarchy for automatic cleanup
- **Large Files**: Implement progress reporting for long-running operations
- **Sprite Caching**: Cache processed sprite data to avoid recomputation

## References

- **Qt6 Documentation**: https://doc.qt.io/qt-6/
- **CMake Documentation**: https://cmake.org/documentation/
- **Legacy System**: See `Legacy_App/` directory for original implementation
- **Requirements**: See `docs/requirements.md` for detailed specifications
- **Design**: See `docs/design.md` for architecture decisions