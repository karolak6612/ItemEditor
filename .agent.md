# ItemEditor Project - Legacy Application & Migration Planning

## Project Overview

This workspace contains both a legacy C# Windows Forms application for editing OpenTibia Binary (OTB) data files and comprehensive migration planning documentation for modernizing it to .NET 9 with WPF + WPFUI.

### Current State - Legacy Application
- **Purpose**: Edit OpenTibia Binary (OTB) data files for Tibia game servers
- **Language**: C# (.NET 9.0 - recently upgraded from .NET Framework 4.8)
- **Framework**: Windows Forms with custom light/dark theme implementation
- **Architecture**: Plugin-based system with modular design
- **Supported Versions**: Tibia client versions 8.00 - 10.77
- **License**: Mixed - MIT License for main app, GNU GPL for some components
- **Target Platform**: Windows (with Mono support for Linux)
- **Build System**: Visual Studio solution with MSBuild
- **Migration Status**: DarkUI removed, custom theme system implemented

### Migration Target
- **Goal**: Modern .NET 9 application with WPF + WPFUI and custom theme system
- **Requirement**: 100% functional parity with beautiful, contemporary UI
- **Timeline**: Planned 10-week migration with 5 distinct phases
- **Theme Management**: Custom light/dark mode toggle throughout application

## Project Structure

### Root Level Files
- **`.agent.md`** - This developer guide (current file)
- **`instructions.md`** - Comprehensive migration planning documentation
- **`acli.exe`** - Command line interface tool

### Legacy Application (`Legacy-App/csharp/`)
- **`ItemEditor.sln`** - Visual Studio solution file
- **`README.md`** - Basic project information and build instructions
- **`LICENSE`** - MIT License for the project
- **`Settings.StyleCop`** - Code style configuration

#### Core Application (`Source/`)
- **`ItemEditor.csproj`** - Main application project (.NET 9.0)
- **`Program.cs`** - Application entry point with plugin services initialization
- **`MainForm.cs/.Designer.cs/.resx`** - Primary application window (extends DarkForm)
- **`app.config`** - Application configuration
- **`ItemEditor.ico`** - Application icon

#### Plugin System (`Source/PluginInterface/`)
- **`PluginInterface.csproj`** - Plugin interface library project
- **`PluginInterface.cs`** - Core plugin contracts (IPlugin, IPluginHost)
- **`Item.cs`** - Base Item and ClientItem classes for game objects
- **`Settings.cs`** - Plugin configuration management
- **`Sprite.cs`** - Sprite handling for game graphics

#### OpenTibia Library (`Source/PluginInterface/OTLib/`)
- **`OTB/`** - OpenTibia Binary file format handlers
  - `OtbReader.cs` - Read OTB files with binary tree parsing
  - `OtbWriter.cs` - Write OTB files
  - `OtbVersionInfo.cs` - Version information management
- **`Server/Items/`** - Server-side item management
  - `ServerItem.cs` - Server item representation with XML naming
  - `ServerItemAttribute.cs` - Item attribute definitions
  - `ServerItemFlag.cs` - Item flag enumerations
  - `ItemsXmlReader.cs` - XML item data parsing
- **`Collections/`** - Specialized collections for server items
- **`Utils/`** - Utility classes for binary operations and special characters

#### User Interface (`Source/Controls/` & `Source/Dialogs/`)
- **Controls:**
  - `ClientItemView.cs` - Custom control for displaying game items with graphics
  - `ServerItemListBox.cs` - Specialized listbox for server items
  - `FlagCheckBox.cs` - Custom checkbox for item flags
  - `ListBase.cs` - Base class for custom list controls
- **Dialogs:**
  - `AboutForm` - Application about dialog
  - `CompareOtbForm` - OTB file comparison tool
  - `FindItemForm` - Item search functionality
  - `NewOtbFileForm` - New OTB file creation wizard
  - `PreferencesForm` - Application settings
  - `ProgressForm` - Progress indication for long operations
  - `UpdateForm` - Application update functionality
  - `UpdateSettingsForm` - Update configuration

#### Support Systems
- **`Source/Helpers/`** - Utility classes
  - `FileNameHelper.cs` - File naming utilities
  - `PathHelper.cs` - Path manipulation utilities
  - `Utils.cs` - General utility functions
- **`Source/Host/`** - Plugin hosting infrastructure
  - `Plugin.cs` - Plugin wrapper and management
  - `PluginCollection.cs` - Plugin collection management
  - `PluginServices.cs` - Central plugin service coordinator
- **`Source/Diagnostics/`** - Debugging and logging
  - `TextBoxTraceListener.cs` - Custom trace listener for UI output

#### Example Plugins
- **`Source/PluginOne/`** - Basic plugin implementation example
- **`Source/PluginTwo/`** - Extended plugin features example
- **`Source/PluginThree/`** - Advanced plugin capabilities example

#### Custom Theme Management
- **Light/Dark Theme Toggle** - Simple user-controlled theme switching
- **Custom Theme Implementation** - Manual light/dark mode implementation without DarkUI
- **Theme Persistence** - Save user theme preference in application settings

## Development Guidelines

### Working with Legacy Code
- **Understand Before Changing** - Study existing patterns before modifications
- **Maintain Plugin Compatibility** - Ensure changes don't break existing plugins
- **Test File Format Compatibility** - Verify .dat, .spr, .otb files still work correctly
- **Preserve UI Workflows** - Keep familiar user interaction patterns
- **Document Breaking Changes** - Clearly document any API or behavior changes

### Migration Planning Reference
- **See `instructions.md`** - Comprehensive migration guide for .NET 9 + WPF + WPFUI
- **Phase-Based Approach** - Follow the 5-phase migration strategy
- **1:1 Function Parity** - Every legacy feature must be preserved
- **Modern UI Design** - Implement contemporary WPFUI design principles
- **Performance Improvements** - Leverage .NET 9 performance enhancements

### Architecture Patterns

#### Plugin System
- **IPlugin Interface** - Core plugin contract with client loading capabilities
  ```csharp
  public interface IPlugin : IDisposable
  {
      bool LoadClient(SupportedClient client, bool extended, bool frameDurations, 
                     bool transparency, string datFullPath, string sprFullPath);
      ClientItem GetClientItem(ushort id);
  }
  ```
- **IPluginHost Interface** - Host services for plugins (currently minimal)
- **PluginServices** - Central plugin management system accessible via `Program.plugins`
- **Modular Design** - Separate plugins for different client versions/features

#### Data Models
- **Item/ClientItem** - Core item data structures with graphics capabilities
- **ServerItem** - Server-side item representation with XML naming support
- **SupportedClient** - Client version definitions with DAT/SPR signatures
- **ServerItemGroup/ServerItemType** - Item categorization enumerations

#### File Format Handling
- **OtbReader/OtbWriter** - Binary OTB file operations with version support
- **ItemsXmlReader** - XML item data parsing for server configurations
- **BinaryTreeReader/Writer** - Low-level binary tree operations for OTB format
- **Signature Validation** - Client version detection via file signatures

## Coding Standards

### Naming Conventions
- **Classes**: PascalCase (e.g., `MainForm`, `ServerItem`, `ClientItemView`)
- **Methods**: PascalCase (e.g., `LoadClient()`, `GetClientItem()`, `OnPaint()`)
- **Properties**: PascalCase (e.g., `ClientId`, `IsCustomCreated`, `SupportedClients`)
- **Fields**: camelCase with descriptive names (e.g., `item`, `destRect`, `sourceRect`)
- **Interfaces**: IPascalCase (e.g., `IPlugin`, `IPluginHost`)
- **Enums**: PascalCase for both enum and values (e.g., `ServerItemGroup.Container`)

### Code Organization Patterns
- **Regions**: Extensive use of `#region` blocks for organization
  - `#region Licence` - GNU GPL license header (required in all files)
  - `#region Using Statements` - Import statements grouped logically
  - `#region Constructor(s)` - Constructor methods
  - `#region Public Properties` - Public properties
  - `#region Private Properties` - Private properties and fields
  - `#region Public Methods` - Public methods
  - `#region Private Methods` - Private methods
  - `#region Event Handlers` - UI event handlers
- **Namespaces**: Hierarchical organization
  - `ItemEditor` - Main application namespace
  - `ItemEditor.Controls` - Custom UI controls
  - `ItemEditor.Dialogs` - Application dialogs
  - `ItemEditor.Host` - Plugin hosting system
  - `PluginInterface` - Plugin contracts and interfaces
  - `OTLib.*` - OpenTibia library components
  - `DarkUI.*` - UI theming components

### Documentation Standards
- **License Headers**: GNU GPL v2+ license required in all source files
- **XML Documentation**: Use for public APIs and plugin interfaces
- **Inline Comments**: Descriptive comments for complex logic and algorithms
- **TODO Comments**: Use `////` for placeholder implementations
- **File Format Documentation**: Document binary format structures and parsing logic

## Dependencies & Build System

### Current Dependencies (.NET 9.0)
- **.NET 9.0-windows** - Target framework with Windows Forms support
- **System.Drawing.Common 9.0.0** - Graphics operations and bitmap handling
- **Implicit Usings** - Enabled for cleaner code
- **Nullable Reference Types** - Enabled for better null safety
- **Unsafe Blocks** - Allowed for binary operations

### Development Tools
- **Visual Studio 2013+** - Primary IDE (solution supports VS 2016+)
- **MSBuild** - Build system with modern SDK-style projects
- **StyleCop** - Code style enforcement (configured via Settings.StyleCop)

### Build Configuration
- **Solution**: `Legacy-App/csharp/ItemEditor.sln`
- **Platform Targets**: AnyCPU, x86, x64
- **Configuration Types**: Debug, Release
- **Project Dependencies**: 
  - ItemEditor → PluginInterface
  - All plugins → PluginInterface

### Build Commands
```bash
# Navigate to solution directory
cd Legacy-App/csharp

# Build entire solution
dotnet build ItemEditor.sln

# Build specific configuration
dotnet build ItemEditor.sln -c Release -p:Platform=x64

# Build and run
dotnet run --project Source/ItemEditor.csproj
```

## File Format Specifications

### OpenTibia Binary (OTB) Files
- **Purpose**: Store server-side item definitions and properties
- **Format**: Binary tree structure with version headers
- **Supported Versions**: Tibia clients 8.00 - 10.77
- **Signature Validation**: Client version detection via DAT/SPR signatures
- **Key Components**: Item attributes, flags, groups, types

### Client Data Files
- **DAT Files**: Client item definitions and metadata
- **SPR Files**: Sprite graphics and animations
- **Signature Detection**: Automatic client version identification
- **Compatibility**: Maintains backward compatibility across versions

### XML Integration
- **Items.xml**: Human-readable item definitions for servers
- **Server Configuration**: Integration with OpenTibia server systems
- **Attribute Mapping**: XML attributes to binary OTB properties

## UI/UX Architecture

### Custom Theme System
- **Base Classes**: Standard `Form`, `Dialog` with custom theme implementation
- **Theme Toggle**: Manual light/dark mode switching via user interface
- **Dynamic Theming**: Real-time theme switching when user changes preference
- **Icon System**: FamFamFam Silk icons with theme-appropriate variants
- **Color Scheme**: Custom light/dark color palettes for consistent theming

### Custom Control Patterns
```csharp
// Custom item display with custom theme support
public class ClientItemView : UserControl
{
    protected override void OnPaint(PaintEventArgs e)
    {
        // Apply current custom theme colors
        // Center and scale item graphics
        // Handle bitmap rendering with proper disposal
    }
    
    private void ApplyTheme(bool isDarkMode)
    {
        // Update colors based on theme preference
        BackColor = isDarkMode ? Color.FromArgb(45, 45, 48) : Color.White;
        ForeColor = isDarkMode ? Color.White : Color.Black;
    }
}
```

### Dialog Management
- **Modal Dialogs**: Progress, preferences, about dialogs with custom theming
- **Tool Windows**: Find, compare, update functionality with theme support
- **Wizard Pattern**: New OTB file creation with step-by-step guidance
- **Theme Consistency**: All dialogs automatically inherit custom theme settings

## Plugin Development Guide

### Plugin Interface Implementation
```csharp
public class ExamplePlugin : IPlugin
{
    public bool LoadClient(SupportedClient client, bool extended, 
                          bool frameDurations, bool transparency, 
                          string datFullPath, string sprFullPath)
    {
        // Load and parse client files
        // Populate Items collection
        // Return success/failure
    }
    
    public ClientItem GetClientItem(ushort id)
    {
        return Items.ContainsKey(id) ? Items[id] : null;
    }
}
```

### Plugin Registration
- **Automatic Discovery**: Plugins loaded from application directory
- **Version Compatibility**: Support for multiple client versions per plugin
- **Resource Management**: Proper disposal and cleanup patterns

## Best Practices & Patterns

### Error Handling Strategy
- **Parameter Validation**: Use `ArgumentNullException` for null parameters
- **File Operations**: Wrap in try-catch with meaningful error messages
- **User Feedback**: Show progress dialogs for long-running operations
- **Graceful Degradation**: Continue operation when non-critical errors occur

### Performance Optimization
- **Lazy Loading**: Load graphics and data only when needed
- **Memory Management**: Dispose of bitmaps and file streams properly
- **Caching Strategy**: Cache frequently accessed items and graphics
- **Background Operations**: Use background threads for file I/O

### Code Quality Guidelines
- **Single Responsibility**: Each class should have one clear purpose
- **Plugin Isolation**: Plugins should not directly depend on each other
- **Resource Cleanup**: Implement IDisposable for classes managing resources
- **Thread Safety**: Consider thread safety for shared plugin services

## Common Development Patterns

### File Loading Pattern
```csharp
public bool LoadOtbFile(string filePath)
{
    try
    {
        using (var reader = new OtbReader())
        {
            // Validate file format
            // Parse binary tree structure
            // Populate item collections
            // Report progress
        }
        return true;
    }
    catch (Exception ex)
    {
        // Log error and show user-friendly message
        return false;
    }
}
```

### Graphics Rendering Pattern
```csharp
protected override void OnPaint(PaintEventArgs e)
{
    if (item?.GetBitmap() is Bitmap bitmap)
    {
        // Calculate centered position
        var destRect = CenterRectangle(bitmap.Size, ClientSize);
        e.Graphics.DrawImage(bitmap, destRect, 
                           new Rectangle(Point.Empty, bitmap.Size), 
                           GraphicsUnit.Pixel);
    }
}
```

## Migration Preparation

### Legacy Code Assessment
- **Identify Dependencies**: Map all external dependencies and their modern equivalents
- **Analyze UI Patterns**: Document current user workflows and interactions
- **Plugin Compatibility**: Ensure migration path preserves plugin functionality
- **Performance Baseline**: Establish current performance metrics for comparison

### Migration Strategy Reference
- **See `instructions.md`**: Complete migration planning documentation
- **Technology Mapping**: Windows Forms → WPF, DarkUI → Custom Theme + WPFUI
- **Architecture Evolution**: Plugin system modernization with dependency injection
- **Testing Strategy**: Comprehensive compatibility and regression testing

*This legacy application provides the foundation for understanding OTB file formats, plugin architectures, and serves as the reference implementation for the planned .NET 9 migration.*